<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MKbotæ’ä»¶</title>
  <script src="static/plugin-info.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * {
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      margin: 0;
      overflow: hidden;
      background: #f0f2f5;
      color: #1f2937;
      font-size: 16px;
      transition: background 0.4s ease, color 0.4s ease;
    }

    html.dark, html.dark body {
      background: #18191C;
      color: #e5e7eb;
    }

    .app-layout {
      display: grid;
      grid-template-rows: auto 1fr;
      height: 100vh;
    }

    header {
      background: white;
      border-bottom: 1px solid #e5e7eb;
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
      gap: 16px;
    }

    .dark header {
      background: #2a2b2e;
      border-color: #3f4045;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
    }

    .header-title {
      font-size: 20px;
      font-weight: 600;
      color: #1f2937;
      flex: 1;
    }

    .dark .header-title {
      color: #e5e7eb;
    }

    .refresh-btn {
      padding: 8px 16px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .refresh-btn:hover {
      background: #2563eb;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .refresh-btn:active {
      transform: scale(0.95);
    }

    .refresh-btn svg {
      width: 16px;
      height: 16px;
      transition: transform 0.5s;
    }

    .refresh-btn.spinning svg {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .main-content {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      padding: 16px;
      min-height: 0;
      overflow: hidden;
      height: calc(100vh - 80px);
      position: relative;
      padding-left: 16px;
    }

    @media (max-width: 768px) {
      .main-content {
        grid-template-columns: 1fr;
        gap: 12px;
        padding: 12px;
        height: calc(100vh - 70px);
        padding-left: 12px;
      }
    }

    /* èœå•æŒ‰é’® - åœ¨headerä¸­ */
    .menu-toggle-btn {
      width: 40px;
      height: 40px;
      background: transparent;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      transition: all 0.3s;
      flex-shrink: 0;
    }

    .menu-toggle-btn:hover {
      background: #f3f4f6;
      transform: scale(1.05);
    }

    .dark .menu-toggle-btn {
      border-color: #3f4045;
    }

    .dark .menu-toggle-btn:hover {
      background: #374151;
    }

    /* ä¾§è¾¹æ  - é»˜è®¤éšè—ï¼Œæ‰“å¼€æ—¶æµ®åœ¨å†…å®¹ä¸Šæ–¹ */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 280px;
      height: 100vh;
      background: white;
      border-right: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      gap: 0;
      padding: 16px;
      overflow-y: auto;
      z-index: 250;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
    }

    .sidebar.open {
      transform: translateX(0);
    }

    .dark .sidebar {
      background: #1f2937;
      border-color: #3f4045;
    }

    /* ä¾§è¾¹æ é®ç½© - ç‚¹å‡»å…³é—­ */
    .sidebar-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 240;
      display: none;
    }

    .sidebar-overlay.open {
      display: block;
    }

    .sidebar::-webkit-scrollbar {
      width: 4px;
    }

    .sidebar::-webkit-scrollbar-thumb {
      background: #e5e7eb;
      border-radius: 10px;
    }

    .sidebar::-webkit-scrollbar-thumb:hover {
      background: #3b82f6;
    }

    .dark .sidebar::-webkit-scrollbar-thumb {
      background: #4a4b50;
    }

    .glass-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
      border: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      transition: all 0.3s;
    }

    .glass-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
    }

    .dark .glass-card {
      background: #2a2b2e;
      border-color: #3f4045;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
    }

    .dark .glass-card:hover {
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    }

    .card-header {
      padding: 16px;
      border-bottom: 1px solid #f3f4f6;
      font-weight: 600;
      font-size: 14px;
      color: #1f2937;
    }

    .dark .card-header {
      border-color: #3f4045;
      color: #e5e7eb;
    }

    .card-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .card-content::-webkit-scrollbar {
      width: 4px;
    }

    .card-content::-webkit-scrollbar-thumb {
      background: #e5e7eb;
      border-radius: 10px;
    }

    .card-content::-webkit-scrollbar-thumb:hover {
      background: #3b82f6;
    }

    .dark .card-content::-webkit-scrollbar-thumb {
      background: #4a4b50;
    }

    .group-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      justify-content: flex-start;
      gap: 8px;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #f3f4f6;
      margin-bottom: 8px;
      background: #fff;
      transition: all 0.3s;
    }

    .dark .group-item {
      background: #374151;
      border-color: #3f4045;
    }

    .group-item:hover {
      border-color: #3b82f6;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
      transform: translateY(-2px);
    }

    .group-info {
      flex: 1;
      min-width: 0;
    }

    .group-name {
      font-weight: 500;
      color: #1f2937;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .dark .group-name {
      color: #e5e7eb;
    }

    .group-id {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 4px;
    }

    .dark .group-id {
      color: #6b7280;
    }

    .toggle-switch {
      position: relative;
      width: 48px;
      height: 24px;
      margin-left: 12px;
      flex-shrink: 0;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      inset: 0;
      background-color: #d1d5db;
      transition: background-color 0.35s, box-shadow 0.3s;
      border-radius: 24px;
    }

    .toggle-slider:hover {
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
    }

    .dark .toggle-slider {
      background-color: #4a4b50;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: transform 0.35s;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    input:checked + .toggle-slider {
      background-color: #3b82f6;
    }

    input:checked + .toggle-slider:before {
      transform: translateX(24px);
    }

    .bulk-actions {
      display: flex;
      gap: 8px;
      padding: 12px;
      border-top: 1px solid #f3f4f6;
    }

    .dark .bulk-actions {
      border-color: #3f4045;
    }

    .bulk-btn {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #e5e7eb;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.3s;
      color: #1f2937;
    }

    .dark .bulk-btn {
      background: #374151;
      border-color: #4a4b50;
      color: #e5e7eb;
    }

    .bulk-btn:hover {
      background: #f3f4f6;
      border-color: #3b82f6;
      color: #3b82f6;
    }

    .dark .bulk-btn:hover {
      background: #4a4b50;
      border-color: #3b82f6;
      color: #3b82f6;
    }

    .bulk-btn:active {
      transform: scale(0.95);
    }

    .empty-state {
      text-align: center;
      padding: 32px 16px;
      color: #9ca3af;
    }

    .dark .empty-state {
      color: #6b7280;
    }

    .empty-icon {
      font-size: 32px;
      margin-bottom: 12px;
    }

    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 100;
    }

    .toast {
      padding: 12px 24px;
      border-radius: 8px;
      color: white;
      margin-bottom: 8px;
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      animation: toastIn 0.3s ease-out;
    }

    .toast.success {
      background: #10b981;
    }

    .toast.error {
      background: #ef4444;
    }

    .toast.info {
      background: #3b82f6;
    }

    @keyframes toastIn {
      from {
        opacity: 0;
        transform: translateX(100%);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .main-area {
      background: white;
      border-radius: 12px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
      border: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #9ca3af;
    }

    .dark .main-area {
      background: #2a2b2e;
      border-color: #3f4045;
      color: #6b7280;
    }

    /* å¯¼èˆªèœå•é¡¹ - åœ†è§’é•¿æ–¹å½¢æŒ‰é’® */
    .nav-item {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 16px;
      cursor: pointer;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      transition: all 0.3s;
      color: #6b7280;
      font-weight: 500;
      background: white;
      margin-bottom: 8px;
    }

    .nav-item:hover {
      background: #f3f4f6;
      color: #3b82f6;
      border-color: #3b82f6;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
    }

    .dark .nav-item {
      background: #374151;
      border-color: #4a4b50;
      color: #e5e7eb;
    }

    .dark .nav-item:hover {
      background: #4a4b50;
      color: #3b82f6;
      border-color: #3b82f6;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .nav-item.active {
      background: #eff6ff;
      border-color: #3b82f6;
      color: #3b82f6;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
    }

    .dark .nav-item.active {
      background: #1e3a8a;
      border-color: #3b82f6;
      color: #3b82f6;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    /* é¡µé¢å†…å®¹ */
    .page-content {
      display: none;
      flex-direction: column;
      min-height: 0;
      overflow: hidden;
    }

    .page-content.active {
      display: flex;
      flex-direction: column;
    }

    .page-content .glass-card {
      min-height: 0;
      overflow: hidden;
    }

    .page-content .glass-card > div:last-child {
      flex: 1;
      overflow-y: auto;
      min-height: 0;
    }
  </style>
</head>
<body>
  <div class="app-layout">
    <!-- Header -->
    <header>
      <button class="menu-toggle-btn" id="menuToggleBtn" onclick="toggleSidebar()" style="position: relative; left: auto; top: auto; margin-right: 16px;">
        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
      </button>
      <div class="header-title">MKbotæ’ä»¶</div>
      <button class="refresh-btn" id="refreshBtn">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
        åˆ·æ–°
      </button>
    </header>

    <!-- Main Content -->
    <div class="main-content">
      <!-- ä¾§è¾¹æ é®ç½© -->
      <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

      <!-- Sidebar Navigation -->
      <div class="sidebar" id="sidebar">
        <div class="nav-item" onclick="switchPage('announcement'); closeSidebar();">
          <span>æ›´æ–°å…¬å‘Š</span>
        </div>
        <div class="nav-item" onclick="switchPage('settings'); closeSidebar();">
          <span>åŸºç¡€è®¾ç½®</span>
        </div>
        <div class="nav-item" onclick="switchPage('group-switch'); closeSidebar();">
          <span>å¼€å…³ç®¡ç†</span>
        </div>
      </div>

      <!-- Main Area - Group Switch Page -->
      <div id="page-group-switch" class="page-content">
        <div class="glass-card" style="height: 100%; display: flex; flex-direction: column;">
          <div style="padding: 16px; border-bottom: 1px solid #f3f4f6;">
            <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px; margin-bottom: 16px;">
              <button class="bulk-btn" id="enableAllBtn" style="padding: 8px 12px; font-size: 12px; white-space: nowrap; flex: 1;">å…¨éƒ¨å¼€å¯</button>
              <div style="font-weight: 600; font-size: 16px; color: #1f2937; cursor: pointer; padding: 0 8px; transition: all 0.3s;" onclick="switchPage('group-switch');">ç¾¤èŠå¼€å…³</div>
              <div style="color: #d1d5db; font-size: 16px;">|</div>
              <div style="font-weight: 600; font-size: 16px; color: #9ca3af; cursor: pointer; padding: 0 8px; transition: all 0.3s;" onclick="switchPage('friend-list');">å¥½å‹å¼€å…³</div>
              <button class="bulk-btn" id="disableAllBtn" style="padding: 8px 12px; font-size: 12px; white-space: nowrap; flex: 1;">å…¨éƒ¨å…³é—­</button>
            </div>
            <input type="text" id="group-search" placeholder="æœç´¢ç¾¤åæˆ–ç¾¤å·..." 
              style="width: 100%; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; outline: none; transition: all 0.3s;"
              oninput="filterGroups()"
              onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)';"
              onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none';">
          </div>
          
          <div style="flex: 1; overflow-y: auto; padding: 16px; background: #f9fafb;">
            <!-- åŠ è½½ä¸­ -->
            <div id="groups-loading" style="text-align: center; padding: 32px 16px;">
              <div style="font-size: 14px; color: #9ca3af;">åŠ è½½ä¸­...</div>
            </div>

            <!-- ç¾¤åˆ—è¡¨å®¹å™¨ -->
            <div id="groups-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px;">
              <!-- åŠ¨æ€ç”Ÿæˆ -->
            </div>

            <!-- ç©ºçŠ¶æ€ -->
            <div id="groups-empty" style="text-align: center; padding: 32px 16px; display: none;">
              <div style="font-size: 14px; color: #9ca3af;">æš‚æ— ç¾¤èŠ</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Area - Friend List Page -->
      <div id="page-friend-list" class="page-content">
        <div class="glass-card" style="height: 100%; display: flex; flex-direction: column;">
          <div style="padding: 16px; border-bottom: 1px solid #f3f4f6;">
            <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px; margin-bottom: 16px;">
              <button class="bulk-btn" id="enableAllFriendsBtn" style="padding: 8px 12px; font-size: 12px; white-space: nowrap; flex: 1;">å…¨éƒ¨å¼€å¯</button>
              <div style="font-weight: 600; font-size: 16px; color: #9ca3af; cursor: pointer; padding: 0 8px; transition: all 0.3s;" onclick="switchPage('group-switch');">ç¾¤èŠå¼€å…³</div>
              <div style="color: #d1d5db; font-size: 16px;">|</div>
              <div style="font-weight: 600; font-size: 16px; color: #1f2937; cursor: pointer; padding: 0 8px; transition: all 0.3s;" onclick="switchPage('friend-list');">å¥½å‹å¼€å…³</div>
              <button class="bulk-btn" id="disableAllFriendsBtn" style="padding: 8px 12px; font-size: 12px; white-space: nowrap; flex: 1;">å…¨éƒ¨å…³é—­</button>
            </div>
            <input type="text" id="friend-search" placeholder="æœç´¢å¥½å‹æ˜µç§°æˆ–QQ..." 
              style="width: 100%; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; outline: none; transition: all 0.3s;"
              oninput="filterFriends()"
              onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)';"
              onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none';">
          </div>
          
          <div style="flex: 1; overflow-y: auto; padding: 16px; background: #f9fafb;">
            <!-- åŠ è½½ä¸­ -->
            <div id="friends-loading" style="text-align: center; padding: 32px 16px;">
              <div style="font-size: 14px; color: #9ca3af;">åŠ è½½ä¸­...</div>
            </div>

            <!-- å¥½å‹åˆ—è¡¨å®¹å™¨ -->
            <div id="friends-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px;">
              <!-- åŠ¨æ€ç”Ÿæˆ -->
            </div>

            <!-- ç©ºçŠ¶æ€ -->
            <div id="friends-empty" style="text-align: center; padding: 32px 16px; display: none;">
              <div style="font-size: 14px; color: #9ca3af;">æš‚æ— å¥½å‹</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Area - Settings Page -->
      <div id="page-settings" class="page-content">
        <div class="glass-card" style="height: 100%; display: flex; flex-direction: column;">
          <div style="padding: 16px; border-bottom: 1px solid #f3f4f6;">
            <div style="font-weight: 600; font-size: 18px; color: #1f2937;">åŸºç¡€è®¾ç½®</div>
          </div>
          
          <div style="flex: 1; overflow-y: auto; padding: 16px; background: #f9fafb;">
            <!-- ä¸»äºº QQ è®¾ç½® -->
            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 10px; padding: 16px; margin-bottom: 16px;">
              <div style="font-weight: 600; font-size: 14px; color: #1f2937; margin-bottom: 8px;">ä¸»äºº QQ</div>
              <input type="text" id="ownerQQsInput" placeholder="å¤šä¸ª QQ ç”¨é€—å·åˆ†éš”ï¼Œå¦‚ï¼š123456,789012" 
                style="width: 100%; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; outline: none; transition: all 0.3s; box-sizing: border-box;"
                onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)';"
                onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none';">
              <div style="font-size: 12px; color: #9ca3af; margin-top: 8px;">æ”¯æŒå¤šç§åˆ†éš”ç¬¦ï¼šé€—å·ã€ä¸­æ–‡é€—å·ã€ç©ºæ ¼ã€&ã€|</div>
            </div>

            <!-- éä¸»äººå›å¤å¼€å…³ -->
            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 10px; padding: 16px; margin-bottom: 16px;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-weight: 600; font-size: 14px; color: #1f2937; margin-bottom: 4px;">éä¸»äººå›å¤å¼€å…³</div>
                  <div style="font-size: 12px; color: #9ca3af;">å¯ç”¨åï¼Œéä¸»äººæ¶ˆæ¯ä¼šè§¦å‘å›å¤</div>
                </div>
                <label class="toggle-switch" style="flex-shrink: 0;">
                  <input type="checkbox" id="nowoner" onchange="saveSettings()">
                  <span class="toggle-slider"></span>
                </label>
              </div>
            </div>

            <!-- éä¸»äººå›å¤å†…å®¹ -->
            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 10px; padding: 16px; margin-bottom: 16px;">
              <div style="font-weight: 600; font-size: 14px; color: #1f2937; margin-bottom: 8px;">éä¸»äººå›å¤å†…å®¹</div>
              <textarea id="nowonernrInput" placeholder="è¾“å…¥éä¸»äººæ¶ˆæ¯çš„å›å¤å†…å®¹" 
                style="width: 100%; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; outline: none; transition: all 0.3s; box-sizing: border-box; min-height: 80px; resize: vertical; font-family: inherit;"
                onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)';"
                onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none';"></textarea>
            </div>

            <!-- æµ‹è¯•åŠŸèƒ½å¼€å…³ -->
            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 10px; padding: 16px; margin-bottom: 16px;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-weight: 600; font-size: 14px; color: #1f2937; margin-bottom: 4px;">æµ‹è¯•åŠŸèƒ½</div>
                  <div style="font-size: 12px; color: #9ca3af;">è¯¥åŠŸèƒ½éœ€é…æ­puppeteeræ’ä»¶ä½¿ç”¨ï¼Œå¯åœ¨æ’ä»¶å•†åº—è¿›è¡Œä¸‹è½½</div>
                </div>
                <label class="toggle-switch" style="flex-shrink: 0;">
                  <input type="checkbox" id="csOf" onchange="saveSettings()">
                  <span class="toggle-slider"></span>
                </label>
              </div>
            </div>

            <!-- ä¿å­˜æŒ‰é’® -->
            <div style="display: flex; gap: 8px;">
              <button class="bulk-btn" id="saveSettingsBtn" style="padding: 10px 16px; font-size: 14px; flex: 1; background: #3b82f6; color: white; border: none; cursor: pointer;" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
              <button class="bulk-btn" id="resetSettingsBtn" style="padding: 10px 16px; font-size: 14px; flex: 1;" onclick="loadSettings()">é‡ç½®</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Area - Announcement Page -->
      <div id="page-announcement" class="page-content">
        <div class="glass-card" style="height: 100%; display: flex; flex-direction: column;">
          <div style="padding: 16px; border-bottom: 1px solid #f3f4f6; text-align: center;">
            <div style="font-weight: 600; font-size: 18px; color: #1f2937;">æ›´æ–°å…¬å‘Š</div>
          </div>
          
          <div style="flex: 1; overflow-y: auto; padding: 16px; background: #f9fafb;">
            <!-- åŠ è½½ä¸­ -->
            <div id="announcement-loading" style="text-align: center; padding: 32px 16px;">
              <div style="font-size: 14px; color: #9ca3af;">åŠ è½½ä¸­...</div>
            </div>
            
            <!-- å…¬å‘Šå†…å®¹ -->
            <div id="announcement-content" style="display: none; white-space: pre-wrap; word-break: break-word; font-family: monospace; font-size: 13px; color: #1f2937; line-height: 1.6;"></div>
            
            <!-- ç©ºçŠ¶æ€ -->
            <div id="announcement-empty" style="text-align: center; padding: 32px 16px; display: none;">
              <div style="font-size: 14px; color: #9ca3af;">æ— </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- è°ƒè¯•é¢æ¿ -->
    <div id="debugPanel" style="position: fixed; bottom: 20px; right: 20px; background: white; border: 1px solid #ccc; border-radius: 8px; padding: 16px; max-width: 400px; max-height: 300px; overflow-y: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; display: none;">
      <div style="font-weight: bold; margin-bottom: 8px;">è°ƒè¯•ä¿¡æ¯</div>
      <div id="debugContent" style="font-size: 12px; font-family: monospace; white-space: pre-wrap; word-break: break-all;"></div>
      <button onclick="document.getElementById('debugPanel').style.display='none'" style="margin-top: 8px; padding: 4px 8px; background: #f0f0f0; border: 1px solid #ccc; border-radius: 4px; cursor: pointer;">å…³é—­</button>
    </div>
    
    <!-- è°ƒè¯•å¼€å…³æŒ‰é’® -->
    <button id="debugToggleBtn" onclick="document.getElementById('debugPanel').style.display = document.getElementById('debugPanel').style.display === 'none' ? 'block' : 'none'" style="position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px; padding: 0; background: #666; color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 12px; z-index: 999; display: flex; align-items: center; justify-content: center;">ğŸ›</button>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <script>
    const ROUTE_PREFIX = '/mkbot';
    const CONFIG_KEY = 'group_of';
    const FRIEND_CONFIG_KEY = 'haoyou_of';
    // ä» localStorage è·å– tokenï¼ˆNapCat WebUI é‰´æƒæ–¹å¼ï¼‰
    const token = localStorage.getItem('token') || '';
    let groupList = [];
    let enabledGroups = [];
    let friendList = [];
    let enabledFriends = [];

    // è·å–æˆæƒè¯·æ±‚å¤´
    function authHeaders(h = {}) {
      if (token) h['Authorization'] = 'Bearer ' + token;
      return h;
    }

    // è°ƒè¯•è¾“å‡º
    function debug(msg) {
      console.log(msg);
      const panel = document.getElementById('debugPanel');
      const content = document.getElementById('debugContent');
      if (panel && content) {
        // ä¸è‡ªåŠ¨æ˜¾ç¤ºé¢æ¿ï¼Œåªè®°å½•å†…å®¹
        content.textContent += msg + '\n';
        content.scrollTop = content.scrollHeight;
      }
    }

    // è·å– API åŸºç¡€è·¯å¾„
    async function resolveApiBase() {
      debug('=== å¼€å§‹è§£æ API åŸºç¡€è·¯å¾„ ===');
      debug('webui_token: ' + (token ? 'å·²è·å–' : 'æœªè·å–'));
      debug('window.__PLUGIN_NAME__: ' + window.__PLUGIN_NAME__);
      debug('location.pathname: ' + location.pathname);
      
      const tries = [];
      if (window.__PLUGIN_NAME__) tries.push(window.__PLUGIN_NAME__);
      try {
        if (window.parent && window.parent.__PLUGIN_NAME__) tries.push(window.parent.__PLUGIN_NAME__);
      } catch (e) { }

      const extMatch = location.pathname.match(/\/ext\/([^\/]+)/);
      if (extMatch) {
        debug('ä» URL æå–æ’ä»¶å: ' + extMatch[1]);
        tries.unshift(extMatch[1]);
      }

      // é»˜è®¤å…œåº•
      tries.push('napcat-plugin-mkbot');

      debug('å°è¯•çš„æ’ä»¶ååˆ—è¡¨: ' + JSON.stringify([...new Set(tries.filter(Boolean))]));

      for (const name of [...new Set(tries.filter(Boolean))]) {
        const base = '/api/Plugin/ext/' + name;
        debug('å°è¯•è·¯å¾„: ' + base + ROUTE_PREFIX + '/config');
        try {
          const r = await fetch(base + ROUTE_PREFIX + '/config', { headers: authHeaders() });
          debug('å“åº”çŠ¶æ€: ' + r.status);
          if (r.ok) {
            debug('[OK] æ‰¾åˆ° API åŸºç¡€è·¯å¾„: ' + base);
            return base;
          }
        } catch (e) {
          debug('[ERROR] å°è¯•å¤±è´¥: ' + e.message);
        }
      }
      const fallback = '/api/Plugin/ext/' + (window.__PLUGIN_NAME__ || 'napcat-plugin-mkbot');
      debug('ä½¿ç”¨å…œåº•è·¯å¾„: ' + fallback);
      return fallback;
    }

    // è°ƒç”¨ API
    async function apiCall(path, options = {}) {
      const url = API_BASE + ROUTE_PREFIX + path;
      debug('[API] è°ƒç”¨: ' + url);
      debug('æ–¹æ³•: ' + (options.method || 'GET'));
      
      try {
        const res = await fetch(url, {
          ...options,
          headers: { 'Content-Type': 'application/json', ...options.headers, ...authHeaders() }
        });
        
        debug('å“åº”çŠ¶æ€: ' + res.status);
        
        if (!res.ok) {
          const text = await res.text();
          debug('[ERROR] é”™è¯¯å“åº”: ' + text);
          throw new Error(text || `HTTP ${res.status}`);
        }
        
        const data = await res.json();
        debug('[OK] å“åº”æ•°æ®: ' + JSON.stringify(data));
        return data;
      } catch (error) {
        debug('[ERROR] API è°ƒç”¨å¤±è´¥: ' + error.message);
        throw error;
      }
    }

    // åˆå§‹åŒ–
    async function init() {
      try {
        debug('=== å¼€å§‹åˆå§‹åŒ– ===');
        API_BASE = await resolveApiBase();
        debug('API åŸºç¡€è·¯å¾„å·²è®¾ç½®: ' + API_BASE);
        
        debug('åŠ è½½é…ç½®...');
        await loadConfig();
        
        debug('è·å–ç¾¤èŠåˆ—è¡¨...');
        await fetchGroupList();
        
        debug('æ¸²æŸ“ç¾¤èŠåˆ—è¡¨...');
        renderGroupList();
        
        debug('[OK] åˆå§‹åŒ–å®Œæˆ');
      } catch (error) {
        debug('[ERROR] åˆå§‹åŒ–å¤±è´¥: ' + error.message);
        showToast('åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
      }
    }

    // åŠ è½½é…ç½®
    async function loadConfig() {
      try {
        debug('[LOAD] åŠ è½½é…ç½®...');
        const data = await apiCall('/config');
        enabledGroups = data.data?.group_of || [];
        enabledFriends = data.data?.haoyou_of || [];
        debug('[OK] é…ç½®åŠ è½½æˆåŠŸï¼Œå¯ç”¨çš„ç¾¤èŠ: ' + JSON.stringify(enabledGroups));
        debug('[OK] é…ç½®åŠ è½½æˆåŠŸï¼Œå¯ç”¨çš„å¥½å‹: ' + JSON.stringify(enabledFriends));
      } catch (error) {
        debug('[ERROR] åŠ è½½é…ç½®å¤±è´¥: ' + error.message);
        showToast('åŠ è½½é…ç½®å¤±è´¥: ' + error.message, 'error');
        enabledGroups = [];
        enabledFriends = [];
      }
    }

    // è·å–ç¾¤èŠåˆ—è¡¨
    async function fetchGroupList() {
      try {
        debug('[LOAD] è·å–ç¾¤èŠåˆ—è¡¨...');
        const data = await apiCall('/groups');
        groupList = data.data?.groups || [];
        debug('[OK] ç¾¤èŠåˆ—è¡¨åŠ è½½æˆåŠŸï¼Œå…± ' + groupList.length + ' ä¸ªç¾¤èŠ');
        debug('ç¾¤èŠæ•°æ®: ' + JSON.stringify(groupList));
      } catch (error) {
        debug('[ERROR] è·å–ç¾¤èŠåˆ—è¡¨å¤±è´¥: ' + error.message);
        showToast('è·å–ç¾¤èŠåˆ—è¡¨å¤±è´¥: ' + error.message, 'error');
        groupList = [];
      }
    }

    // è·å–å¥½å‹åˆ—è¡¨
    async function fetchFriendList() {
      try {
        debug('[LOAD] è·å–å¥½å‹åˆ—è¡¨...');
        const data = await apiCall('/friends');
        friendList = data.data?.friends || [];
        debug('[OK] å¥½å‹åˆ—è¡¨åŠ è½½æˆåŠŸï¼Œå…± ' + friendList.length + ' ä¸ªå¥½å‹');
        debug('å¥½å‹æ•°æ®: ' + JSON.stringify(friendList));
      } catch (error) {
        debug('[ERROR] è·å–å¥½å‹åˆ—è¡¨å¤±è´¥: ' + error.message);
        showToast('è·å–å¥½å‹åˆ—è¡¨å¤±è´¥: ' + error.message, 'error');
        friendList = [];
      }
    }

    // æ¸²æŸ“ç¾¤èŠåˆ—è¡¨
    function renderGroupList() {
      const container = document.getElementById('groups-container');
      const empty = document.getElementById('groups-empty');
      const loading = document.getElementById('groups-loading');
      
      loading.style.display = 'none';
      
      if (groupList.length === 0) {
        container.style.display = 'none';
        empty.style.display = 'block';
        return;
      }

      container.style.display = 'grid';
      empty.style.display = 'none';

      container.innerHTML = groupList.map(group => {
        const isEnabled = enabledGroups.includes(String(group.group_id));
        const avatarUrl = `http://p.qlogo.cn/gh/${group.group_id}/${group.group_id}/100/`;
        const groupName = (group.group_name || 'æœªçŸ¥ç¾¤èŠ').substring(0, 10);
        return `
          <div style="background: white; border: 1px solid #e5e7eb; border-radius: 10px; padding: 12px; transition: all 0.3s; cursor: pointer; display: flex; flex-direction: column; align-items: center; text-align: center;"
            onmouseover="this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.2)'; this.style.borderColor='#3b82f6'; this.style.transform='translateY(-2px)';"
            onmouseout="this.style.boxShadow='none'; this.style.borderColor='#e5e7eb'; this.style.transform='translateY(0)';">
            <div style="width: 50px; height: 50px; border-radius: 8px; background: #f3f4f6; display: flex; align-items: center; justify-content: center; flex-shrink: 0; overflow: hidden; border: 1px solid #e5e7eb; margin-bottom: 8px;">
              <img src="${avatarUrl}" alt="" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.style.display='none'; this.parentElement.innerHTML='${(group.group_name || 'G')[0]}';">
            </div>
            <div style="flex: 1; min-width: 0; margin-bottom: 8px; width: 100%;">
              <div style="font-weight: 500; color: #1f2937; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${groupName}${group.group_name && group.group_name.length > 10 ? '...' : ''}</div>
              <div style="font-size: 11px; color: #9ca3af; margin-top: 2px; font-family: monospace;">${group.group_id}</div>
            </div>
            <label class="toggle-switch" style="flex-shrink: 0;">
              <input type="checkbox" ${isEnabled ? 'checked' : ''} onchange="toggleGroup('${group.group_id}', this.checked)">
              <span class="toggle-slider"></span>
            </label>
          </div>
        `;
      }).join('');
    }

    // è¿‡æ»¤ç¾¤èŠåˆ—è¡¨
    function filterGroups() {
      const searchInput = document.getElementById('group-search');
      const filter = searchInput.value.trim().toLowerCase();
      const container = document.getElementById('groups-container');
      const empty = document.getElementById('groups-empty');
      
      if (groupList.length === 0) {
        container.style.display = 'none';
        empty.style.display = 'block';
        return;
      }

      const filtered = filter ? groupList.filter(g => 
        (g.group_name || '').toLowerCase().includes(filter) || 
        String(g.group_id).includes(filter)
      ) : groupList;

      if (filtered.length === 0) {
        container.style.display = 'none';
        empty.style.display = 'block';
        empty.innerHTML = '<div style="font-size: 14px; color: #9ca3af;">æœªæ‰¾åˆ°åŒ¹é…çš„ç¾¤èŠ</div>';
        return;
      }

      container.style.display = 'grid';
      empty.style.display = 'none';

      container.innerHTML = filtered.map(group => {
        const isEnabled = enabledGroups.includes(String(group.group_id));
        const avatarUrl = `http://p.qlogo.cn/gh/${group.group_id}/${group.group_id}/100/`;
        const groupName = (group.group_name || 'æœªçŸ¥ç¾¤èŠ').substring(0, 10);
        return `
          <div style="background: white; border: 1px solid #e5e7eb; border-radius: 10px; padding: 12px; transition: all 0.3s; cursor: pointer; display: flex; flex-direction: column; align-items: center; text-align: center;"
            onmouseover="this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.2)'; this.style.borderColor='#3b82f6'; this.style.transform='translateY(-2px)';"
            onmouseout="this.style.boxShadow='none'; this.style.borderColor='#e5e7eb'; this.style.transform='translateY(0)';">
            <div style="width: 50px; height: 50px; border-radius: 8px; background: #f3f4f6; display: flex; align-items: center; justify-content: center; flex-shrink: 0; overflow: hidden; border: 1px solid #e5e7eb; margin-bottom: 8px;">
              <img src="${avatarUrl}" alt="" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.style.display='none'; this.parentElement.innerHTML='${(group.group_name || 'G')[0]}';">
            </div>
            <div style="flex: 1; min-width: 0; margin-bottom: 8px; width: 100%;">
              <div style="font-weight: 500; color: #1f2937; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${groupName}${group.group_name && group.group_name.length > 10 ? '...' : ''}</div>
              <div style="font-size: 11px; color: #9ca3af; margin-top: 2px; font-family: monospace;">${group.group_id}</div>
            </div>
            <label class="toggle-switch" style="flex-shrink: 0;">
              <input type="checkbox" ${isEnabled ? 'checked' : ''} onchange="toggleGroup('${group.group_id}', this.checked)">
              <span class="toggle-slider"></span>
            </label>
          </div>
        `;
      }).join('');
    }

    // åˆ‡æ¢ç¾¤èŠå¼€å…³
    async function toggleGroup(groupId, enabled) {
      const index = enabledGroups.indexOf(String(groupId));
      
      if (enabled && index === -1) {
        enabledGroups.push(String(groupId));
      } else if (!enabled && index !== -1) {
        enabledGroups.splice(index, 1);
      }

      await saveConfig();
      showToast(`ç¾¤èŠ ${groupId} å·²${enabled ? 'å¼€å¯' : 'å…³é—­'}`, 'success');
    }

    // å…¨éƒ¨å¼€å¯
    async function enableAll() {
      enabledGroups = groupList.map(g => String(g.group_id));
      await saveConfig();
      renderGroupList();
      showToast('å·²å…¨éƒ¨å¼€å¯', 'success');
    }

    // å…¨éƒ¨å…³é—­
    async function disableAll() {
      enabledGroups = [];
      await saveConfig();
      renderGroupList();
      showToast('å·²å…¨éƒ¨å…³é—­', 'success');
    }

    // ä¿å­˜é…ç½®
    async function saveConfig() {
      try {
        debug('[SAVE] ä¿å­˜é…ç½®: ' + JSON.stringify({ [CONFIG_KEY]: enabledGroups, [FRIEND_CONFIG_KEY]: enabledFriends }));
        const data = await apiCall('/config', {
          method: 'POST',
          body: JSON.stringify({ [CONFIG_KEY]: enabledGroups, [FRIEND_CONFIG_KEY]: enabledFriends })
        });
        debug('[OK] é…ç½®ä¿å­˜æˆåŠŸ');
      } catch (error) {
        debug('[ERROR] ä¿å­˜é…ç½®å¤±è´¥: ' + error.message);
        showToast('ä¿å­˜é…ç½®å¤±è´¥: ' + error.message, 'error');
      }
    }

    // åˆ·æ–°
    async function refresh() {
      const btn = document.getElementById('refreshBtn');
      btn.classList.add('spinning');
      debug('[REFRESH] å¼€å§‹åˆ·æ–°...');
      
      try {
        await fetchGroupList();
        await loadConfig();
        renderGroupList();
        debug('[OK] åˆ·æ–°æˆåŠŸ');
        showToast('åˆ·æ–°æˆåŠŸ', 'success');
      } catch (error) {
        debug('[ERROR] åˆ·æ–°å¤±è´¥: ' + error.message);
        showToast('åˆ·æ–°å¤±è´¥: ' + error.message, 'error');
      } finally {
        btn.classList.remove('spinning');
      }
    }

    // æ˜¾ç¤ºæç¤º
    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      container.appendChild(toast);

      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    // æ¸²æŸ“å¥½å‹åˆ—è¡¨
    function renderFriendList() {
      const container = document.getElementById('friends-container');
      const empty = document.getElementById('friends-empty');
      const loading = document.getElementById('friends-loading');
      
      loading.style.display = 'none';
      
      if (friendList.length === 0) {
        container.style.display = 'none';
        empty.style.display = 'block';
        return;
      }

      container.style.display = 'grid';
      container.style.gridTemplateColumns = 'repeat(auto-fill, minmax(150px, 1fr))';
      container.style.gap = '12px';
      empty.style.display = 'none';

      container.innerHTML = friendList.map(friend => {
        const isEnabled = enabledFriends.includes(String(friend.user_id));
        const avatarUrl = `http://q.qlogo.cn/headimg_dl?dst_uin=${friend.user_id}&spec=640`;
        const friendName = (friend.nickname || 'æœªçŸ¥å¥½å‹').substring(0, 10);
        return `
          <div style="background: white; border: 1px solid #e5e7eb; border-radius: 10px; padding: 12px; transition: all 0.3s; cursor: pointer; display: flex; flex-direction: column; align-items: center; text-align: center;"
            onmouseover="this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.2)'; this.style.borderColor='#3b82f6'; this.style.transform='translateY(-2px)';"
            onmouseout="this.style.boxShadow='none'; this.style.borderColor='#e5e7eb'; this.style.transform='translateY(0)';">
            <div style="width: 50px; height: 50px; border-radius: 8px; background: #f3f4f6; display: flex; align-items: center; justify-content: center; flex-shrink: 0; overflow: hidden; border: 1px solid #e5e7eb; margin-bottom: 8px;">
              <img src="${avatarUrl}" alt="" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.style.display='none'; this.parentElement.innerHTML='${(friend.nickname || 'F')[0]}';">
            </div>
            <div style="flex: 1; min-width: 0; margin-bottom: 8px; width: 100%;">
              <div style="font-weight: 500; color: #1f2937; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${friendName}${friend.nickname && friend.nickname.length > 10 ? '...' : ''}</div>
              <div style="font-size: 11px; color: #9ca3af; margin-top: 2px; font-family: monospace;">${friend.user_id}</div>
            </div>
            <label class="toggle-switch" style="flex-shrink: 0;">
              <input type="checkbox" ${isEnabled ? 'checked' : ''} onchange="toggleFriend('${friend.user_id}', this.checked)">
              <span class="toggle-slider"></span>
            </label>
          </div>
        `;
      }).join('');
    }

    // è¿‡æ»¤å¥½å‹åˆ—è¡¨
    function filterFriends() {
      const searchInput = document.getElementById('friend-search');
      const filter = searchInput.value.trim().toLowerCase();
      const container = document.getElementById('friends-container');
      const empty = document.getElementById('friends-empty');
      
      if (friendList.length === 0) {
        container.style.display = 'none';
        empty.style.display = 'block';
        return;
      }

      const filtered = filter ? friendList.filter(f => 
        (f.nickname || '').toLowerCase().includes(filter) || 
        String(f.user_id).includes(filter)
      ) : friendList;

      if (filtered.length === 0) {
        container.style.display = 'none';
        empty.style.display = 'block';
        empty.innerHTML = '<div style="font-size: 14px; color: #9ca3af;">æœªæ‰¾åˆ°åŒ¹é…çš„å¥½å‹</div>';
        return;
      }

      container.style.display = 'grid';
      empty.style.display = 'none';

      container.innerHTML = filtered.map(friend => {
        const isEnabled = enabledFriends.includes(String(friend.user_id));
        const avatarUrl = `http://q.qlogo.cn/headimg_dl?dst_uin=${friend.user_id}&spec=640`;
        const friendName = (friend.nickname || 'æœªçŸ¥å¥½å‹').substring(0, 10);
        return `
          <div style="background: white; border: 1px solid #e5e7eb; border-radius: 10px; padding: 12px; transition: all 0.3s; cursor: pointer; display: flex; flex-direction: column; align-items: center; text-align: center;"
            onmouseover="this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.2)'; this.style.borderColor='#3b82f6'; this.style.transform='translateY(-2px)';"
            onmouseout="this.style.boxShadow='none'; this.style.borderColor='#e5e7eb'; this.style.transform='translateY(0)';">
            <div style="width: 50px; height: 50px; border-radius: 8px; background: #f3f4f6; display: flex; align-items: center; justify-content: center; flex-shrink: 0; overflow: hidden; border: 1px solid #e5e7eb; margin-bottom: 8px;">
              <img src="${avatarUrl}" alt="" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.style.display='none'; this.parentElement.innerHTML='${(friend.nickname || 'F')[0]}';">
            </div>
            <div style="flex: 1; min-width: 0; margin-bottom: 8px; width: 100%;">
              <div style="font-weight: 500; color: #1f2937; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${friendName}${friend.nickname && friend.nickname.length > 10 ? '...' : ''}</div>
              <div style="font-size: 11px; color: #9ca3af; margin-top: 2px; font-family: monospace;">${friend.user_id}</div>
            </div>
            <label class="toggle-switch" style="flex-shrink: 0;">
              <input type="checkbox" ${isEnabled ? 'checked' : ''} onchange="toggleFriend('${friend.user_id}', this.checked)">
              <span class="toggle-slider"></span>
            </label>
          </div>
        `;
      }).join('');
    }

    // åˆ‡æ¢å¥½å‹å¼€å…³
    async function toggleFriend(friendId, enabled) {
      const index = enabledFriends.indexOf(String(friendId));
      
      if (enabled && index === -1) {
        enabledFriends.push(String(friendId));
      } else if (!enabled && index !== -1) {
        enabledFriends.splice(index, 1);
      }

      await saveFriendConfig();
      showToast(`å¥½å‹ ${friendId} å·²${enabled ? 'å¼€å¯' : 'å…³é—­'}`, 'success');
    }

    // å…¨éƒ¨å¼€å¯å¥½å‹
    async function enableAllFriends() {
      enabledFriends = friendList.map(f => String(f.user_id));
      await saveFriendConfig();
      renderFriendList();
      showToast('å·²å…¨éƒ¨å¼€å¯', 'success');
    }

    // å…¨éƒ¨å…³é—­å¥½å‹
    async function disableAllFriends() {
      enabledFriends = [];
      await saveFriendConfig();
      renderFriendList();
      showToast('å·²å…¨éƒ¨å…³é—­', 'success');
    }

    // ä¿å­˜å¥½å‹é…ç½®
    async function saveFriendConfig() {
      try {
        debug('[SAVE] ä¿å­˜å¥½å‹é…ç½®: ' + JSON.stringify({ [FRIEND_CONFIG_KEY]: enabledFriends }));
        const data = await apiCall('/config', {
          method: 'POST',
          body: JSON.stringify({ [FRIEND_CONFIG_KEY]: enabledFriends })
        });
        debug('[OK] å¥½å‹é…ç½®ä¿å­˜æˆåŠŸ');
      } catch (error) {
        debug('[ERROR] ä¿å­˜å¥½å‹é…ç½®å¤±è´¥: ' + error.message);
        showToast('ä¿å­˜å¥½å‹é…ç½®å¤±è´¥: ' + error.message, 'error');
      }
    }

    // åˆ‡æ¢ä¾§è¾¹æ 
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      sidebar.classList.toggle('open');
      overlay.classList.toggle('open');
    }

    // å…³é—­ä¾§è¾¹æ 
    function closeSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      sidebar.classList.remove('open');
      overlay.classList.remove('open');
    }

    // åˆ‡æ¢é¡µé¢
    function switchPage(pageId) {
      debug('åˆ‡æ¢é¡µé¢: ' + pageId);
      
      // éšè—æ‰€æœ‰é¡µé¢
      document.querySelectorAll('.page-content').forEach(page => {
        page.classList.remove('active');
      });
      
      // ç§»é™¤æ‰€æœ‰å¯¼èˆªé¡¹çš„ active çŠ¶æ€
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      
      // æ˜¾ç¤ºé€‰ä¸­çš„é¡µé¢
      const page = document.getElementById('page-' + pageId);
      if (page) {
        page.classList.add('active');
      }
      
      // æ›´æ–°å¯¼èˆªèœå•çš„ active çŠ¶æ€
      const navItems = document.querySelectorAll('.nav-item');
      navItems.forEach(item => {
        const pageLink = item.getAttribute('onclick');
        if (pageLink && pageLink.includes(`switchPage('${pageId}')`)) {
          item.classList.add('active');
        }
      });
      
      // æ ¹æ®é¡µé¢ç±»å‹åŠ è½½æ•°æ®
      if (pageId === 'group-switch') {
        renderGroupList();
      } else if (pageId === 'friend-list') {
        if (friendList.length === 0) {
          fetchFriendList().then(() => renderFriendList());
        } else {
          renderFriendList();
        }
      } else if (pageId === 'settings') {
        loadSettings();
      } else if (pageId === 'announcement') {
        loadAnnouncement();
      }
    }

    // åŠ è½½æ›´æ–°å…¬å‘Š
    async function loadAnnouncement() {
      try {
        debug('[LOAD] åŠ è½½æ›´æ–°å…¬å‘Š...');
        const loading = document.getElementById('announcement-loading');
        const content = document.getElementById('announcement-content');
        const empty = document.getElementById('announcement-empty');
        
        loading.style.display = 'block';
        content.style.display = 'none';
        empty.style.display = 'none';
        
        const data = await apiCall('/announcement');
        debug('[OK] å…¬å‘ŠåŠ è½½æˆåŠŸ');
        
        loading.style.display = 'none';
        
        const text = data.data || '';
        if (text.trim()) {
          content.textContent = text;
          content.style.display = 'block';
        } else {
          empty.style.display = 'block';
        }
      } catch (error) {
        debug('[ERROR] åŠ è½½å…¬å‘Šå¤±è´¥: ' + error.message);
        loading.style.display = 'none';
        empty.style.display = 'block';
      }
    }

    // åˆå§‹åŒ–
    async function initPage() {
      // æ˜¾ç¤ºç¬¬ä¸€ä¸ªé¡µé¢ï¼ˆæ›´æ–°å…¬å‘Šï¼‰
      const firstPage = document.getElementById('page-announcement');
      if (firstPage) {
        firstPage.classList.add('active');
      }
      const firstNav = document.querySelector('.nav-item');
      if (firstNav) {
        firstNav.classList.add('active');
      }
      
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      document.getElementById('groups-loading').style.display = 'block';
      document.getElementById('groups-container').style.display = 'none';
      document.getElementById('groups-empty').style.display = 'none';
      document.getElementById('friends-loading').style.display = 'none';
      document.getElementById('friends-container').style.display = 'none';
      document.getElementById('friends-empty').style.display = 'none';
      
      // åˆå§‹åŒ–æ•°æ®
      await init();
      
      // åŠ è½½å…¬å‘Š
      await loadAnnouncement();
    }

    // åŠ è½½è®¾ç½®
    async function loadSettings() {
      try {
        debug('[LOAD] åŠ è½½è®¾ç½®...');
        const data = await apiCall('/config');
        const config = data.data || {};
        
        // å¡«å……è¡¨å•
        document.getElementById('ownerQQsInput').value = Array.isArray(config.OwnerQQs) ? config.OwnerQQs.join(', ') : '';
        document.getElementById('nowoner').checked = config.nowoner ?? true;
        document.getElementById('nowonernrInput').value = config.nowonernr ?? '';
        document.getElementById('csOf').checked = config.cs_of ?? false;
        
        debug('[OK] è®¾ç½®åŠ è½½æˆåŠŸ');
      } catch (error) {
        debug('[ERROR] åŠ è½½è®¾ç½®å¤±è´¥: ' + error.message);
        showToast('åŠ è½½è®¾ç½®å¤±è´¥: ' + error.message, 'error');
      }
    }

    // ä¿å­˜è®¾ç½®
    async function saveSettings() {
      try {
        const ownerQQsStr = document.getElementById('ownerQQsInput').value.trim();
        const nowoner = document.getElementById('nowoner').checked;
        const nowonernr = document.getElementById('nowonernrInput').value.trim();
        const csOf = document.getElementById('csOf').checked;
        
        // è§£æ QQ å·
        const qqArray = ownerQQsStr
          .split(/[,ï¼Œã€\s&|]+/)
          .map(qq => qq.trim())
          .filter(qq => qq && /^\d+$/.test(qq));
        
        const config = {
          OwnerQQs: qqArray,
          nowoner: nowoner,
          nowonernr: nowonernr,
          cs_of: csOf
        };
        
        debug('[SAVE] ä¿å­˜è®¾ç½®: ' + JSON.stringify(config));
        const data = await apiCall('/config', {
          method: 'POST',
          body: JSON.stringify(config)
        });
        debug('[OK] è®¾ç½®ä¿å­˜æˆåŠŸ');
        showToast('è®¾ç½®å·²ä¿å­˜', 'success');
      } catch (error) {
        debug('[ERROR] ä¿å­˜è®¾ç½®å¤±è´¥: ' + error.message);
        showToast('ä¿å­˜è®¾ç½®å¤±è´¥: ' + error.message, 'error');
      }
    }

    // äº‹ä»¶ç›‘å¬
    document.getElementById('refreshBtn').addEventListener('click', refresh);
    document.getElementById('enableAllBtn').addEventListener('click', enableAll);
    document.getElementById('disableAllBtn').addEventListener('click', disableAll);
    document.getElementById('enableAllFriendsBtn').addEventListener('click', enableAllFriends);
    document.getElementById('disableAllFriendsBtn').addEventListener('click', disableAllFriends);

    initPage();
  </script>
</body>
</html>
